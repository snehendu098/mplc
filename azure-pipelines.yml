# Azure DevOps CI/CD Pipeline for SRGG Marketplace
# Builds, tests, and deploys the Next.js application

trigger:
  branches:
    include:
      - main
      - develop
  paths:
    exclude:
      - README.md
      - docs/*

pr:
  branches:
    include:
      - main
      - develop

variables:
  - name: nodeVersion
    value: '20.x'
  - name: npmCache
    value: $(Pipeline.Workspace)/.npm
  - name: isMain
    value: $[eq(variables['Build.SourceBranch'], 'refs/heads/main')]
  - name: isDevelop
    value: $[eq(variables['Build.SourceBranch'], 'refs/heads/develop')]

stages:
  # ============================================
  # BUILD STAGE
  # ============================================
  - stage: Build
    displayName: 'Build & Test'
    jobs:
      - job: BuildJob
        displayName: 'Build Application'
        pool:
          vmImage: 'ubuntu-latest'
        steps:
          - task: NodeTool@0
            displayName: 'Install Node.js'
            inputs:
              versionSpec: $(nodeVersion)

          - task: Cache@2
            displayName: 'Cache npm packages'
            inputs:
              key: 'npm | "$(Agent.OS)" | package-lock.json'
              restoreKeys: |
                npm | "$(Agent.OS)"
              path: $(npmCache)

          - script: |
              npm ci --cache $(npmCache)
            displayName: 'Install dependencies'

          - script: |
              npx prisma generate
            displayName: 'Generate Prisma Client'

          - script: |
              npm run build
            displayName: 'Build Next.js application'
            env:
              NODE_ENV: production

          - task: CopyFiles@2
            displayName: 'Copy build artifacts'
            inputs:
              sourceFolder: '$(Build.SourcesDirectory)'
              contents: |
                .next/**
                public/**
                package.json
                package-lock.json
                next.config.ts
                prisma/**
                !prisma/dev.db
              targetFolder: '$(Build.ArtifactStagingDirectory)'

          - task: PublishBuildArtifacts@1
            displayName: 'Publish build artifacts'
            inputs:
              pathToPublish: '$(Build.ArtifactStagingDirectory)'
              artifactName: 'srgg-marketplace'
              publishLocation: 'Container'

  # ============================================
  # DEPLOY TO STAGING (develop branch)
  # ============================================
  - stage: DeployStaging
    displayName: 'Deploy to Staging'
    dependsOn: Build
    condition: and(succeeded(), eq(variables.isDevelop, true))
    jobs:
      - deployment: DeployStaging
        displayName: 'Deploy to Staging Environment'
        pool:
          vmImage: 'ubuntu-latest'
        environment: 'staging'
        strategy:
          runOnce:
            deploy:
              steps:
                - task: DownloadBuildArtifacts@1
                  displayName: 'Download artifacts'
                  inputs:
                    buildType: 'current'
                    downloadType: 'single'
                    artifactName: 'srgg-marketplace'
                    downloadPath: '$(System.ArtifactsDirectory)'

                # Option 1: Deploy to Azure App Service
                - task: AzureWebApp@1
                  displayName: 'Deploy to Azure App Service (Staging)'
                  inputs:
                    azureSubscription: '$(AzureSubscription)'
                    appType: 'webAppLinux'
                    appName: '$(StagingAppName)'
                    package: '$(System.ArtifactsDirectory)/srgg-marketplace'
                    runtimeStack: 'NODE|20-lts'
                    startUpCommand: 'npm run start'

  # ============================================
  # DEPLOY TO PRODUCTION (main branch)
  # ============================================
  - stage: DeployProduction
    displayName: 'Deploy to Production'
    dependsOn: Build
    condition: and(succeeded(), eq(variables.isMain, true))
    jobs:
      - deployment: DeployProduction
        displayName: 'Deploy to Production Environment'
        pool:
          vmImage: 'ubuntu-latest'
        environment: 'production'
        strategy:
          runOnce:
            deploy:
              steps:
                - task: DownloadBuildArtifacts@1
                  displayName: 'Download artifacts'
                  inputs:
                    buildType: 'current'
                    downloadType: 'single'
                    artifactName: 'srgg-marketplace'
                    downloadPath: '$(System.ArtifactsDirectory)'

                # Deploy to Azure App Service (Production)
                - task: AzureWebApp@1
                  displayName: 'Deploy to Azure App Service (Production)'
                  inputs:
                    azureSubscription: '$(AzureSubscription)'
                    appType: 'webAppLinux'
                    appName: '$(ProductionAppName)'
                    package: '$(System.ArtifactsDirectory)/srgg-marketplace'
                    runtimeStack: 'NODE|20-lts'
                    startUpCommand: 'npm run start'
