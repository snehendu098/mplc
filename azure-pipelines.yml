# ============================================
# SRGG Marketplace - Azure DevOps Pipeline
# ============================================
# Complete CI/CD pipeline for Azure App Service
#
# Setup Instructions: See AZURE_DEVOPS_GUIDE.md
# ============================================

trigger:
  branches:
    include:
      - main
      - develop
  paths:
    exclude:
      - '*.md'
      - 'docs/**'
      - '.github/**'

pr:
  branches:
    include:
      - main
      - develop

# ============================================
# VARIABLES
# ============================================
# Configure these in Azure DevOps Pipeline Variables:
# - AzureSubscription: Your Azure service connection name
# - StagingAppName: Your staging app service name
# - ProductionAppName: Your production app service name
# ============================================

variables:
  - name: nodeVersion
    value: '20.x'
  - name: npmCache
    value: $(Pipeline.Workspace)/.npm
  - name: isMain
    value: $[eq(variables['Build.SourceBranch'], 'refs/heads/main')]
  - name: isDevelop
    value: $[eq(variables['Build.SourceBranch'], 'refs/heads/develop')]

stages:
  # ============================================
  # STAGE 1: BUILD & TEST
  # ============================================
  - stage: Build
    displayName: 'ðŸ”¨ Build & Test'
    jobs:
      - job: BuildJob
        displayName: 'Build Application'
        pool:
          vmImage: 'ubuntu-latest'

        steps:
          # Checkout code
          - checkout: self
            displayName: 'ðŸ“¥ Checkout repository'

          # Setup Node.js
          - task: NodeTool@0
            displayName: 'ðŸ“¦ Setup Node.js $(nodeVersion)'
            inputs:
              versionSpec: $(nodeVersion)

          # Cache npm packages
          - task: Cache@2
            displayName: 'ðŸ’¾ Cache npm packages'
            inputs:
              key: 'npm | "$(Agent.OS)" | package-lock.json'
              restoreKeys: |
                npm | "$(Agent.OS)"
              path: $(npmCache)

          # Install dependencies
          - script: npm ci --cache $(npmCache)
            displayName: 'ðŸ“š Install dependencies'

          # Generate Prisma Client
          - script: npx prisma generate
            displayName: 'ðŸ—„ï¸ Generate Prisma Client'

          # Run linting (optional, continues on error)
          - script: npm run lint --if-present
            displayName: 'ðŸ” Run ESLint'
            continueOnError: 'true'

          # Run tests (optional, continues on error)
          - script: npm test --if-present
            displayName: 'ðŸ§ª Run Tests'
            continueOnError: 'true'

          # Build application
          - script: npm run build
            displayName: 'ðŸ—ï¸ Build Next.js Application'
            env:
              NODE_ENV: production

          # Copy files for deployment
          - task: CopyFiles@2
            displayName: 'ðŸ“‹ Prepare deployment package'
            inputs:
              sourceFolder: '$(Build.SourcesDirectory)'
              contents: |
                .next/**
                !.next/cache/**
                public/**
                package.json
                package-lock.json
                next.config.ts
                prisma/schema.prisma
                node_modules/.prisma/**
              targetFolder: '$(Build.ArtifactStagingDirectory)/app'

          # Create startup script
          - script: |
              cat > $(Build.ArtifactStagingDirectory)/app/startup.sh << 'EOF'
              #!/bin/bash
              npm install --production
              npx prisma generate
              npm run start
              EOF
              chmod +x $(Build.ArtifactStagingDirectory)/app/startup.sh
            displayName: 'ðŸ“ Create startup script'

          # Publish artifact
          - task: PublishBuildArtifacts@1
            displayName: 'ðŸ“¤ Publish build artifacts'
            inputs:
              pathToPublish: '$(Build.ArtifactStagingDirectory)/app'
              artifactName: 'srgg-marketplace'
              publishLocation: 'Container'

          # Build summary
          - script: |
              echo "##vso[task.logissue type=info]âœ… Build completed successfully!"
              echo "Branch: $(Build.SourceBranchName)"
              echo "Commit: $(Build.SourceVersion)"
            displayName: 'âœ… Build Summary'

  # ============================================
  # STAGE 2: DEPLOY TO STAGING
  # ============================================
  - stage: DeployStaging
    displayName: 'ðŸš€ Deploy to Staging'
    dependsOn: Build
    condition: and(succeeded(), eq(variables.isDevelop, true))

    jobs:
      - deployment: DeployToStaging
        displayName: 'Deploy to Staging Environment'
        pool:
          vmImage: 'ubuntu-latest'
        environment: 'staging'

        strategy:
          runOnce:
            deploy:
              steps:
                # Download artifacts
                - task: DownloadBuildArtifacts@1
                  displayName: 'ðŸ“¥ Download build artifacts'
                  inputs:
                    buildType: 'current'
                    downloadType: 'single'
                    artifactName: 'srgg-marketplace'
                    downloadPath: '$(System.ArtifactsDirectory)'

                # Deploy to Azure App Service
                - task: AzureWebApp@1
                  displayName: 'ðŸŒ Deploy to Azure App Service (Staging)'
                  inputs:
                    azureSubscription: '$(AzureSubscription)'
                    appType: 'webAppLinux'
                    appName: '$(StagingAppName)'
                    package: '$(System.ArtifactsDirectory)/srgg-marketplace'
                    runtimeStack: 'NODE|20-lts'
                    startUpCommand: 'npm run start'

                # Verify deployment
                - script: |
                    echo "##vso[task.logissue type=info]âœ… Staging deployment complete!"
                    echo "URL: https://$(StagingAppName).azurewebsites.net"
                  displayName: 'âœ… Deployment Summary'

  # ============================================
  # STAGE 3: DEPLOY TO PRODUCTION
  # ============================================
  - stage: DeployProduction
    displayName: 'ðŸš€ Deploy to Production'
    dependsOn: Build
    condition: and(succeeded(), eq(variables.isMain, true))

    jobs:
      - deployment: DeployToProduction
        displayName: 'Deploy to Production Environment'
        pool:
          vmImage: 'ubuntu-latest'
        environment: 'production'  # Requires approval if configured

        strategy:
          runOnce:
            deploy:
              steps:
                # Download artifacts
                - task: DownloadBuildArtifacts@1
                  displayName: 'ðŸ“¥ Download build artifacts'
                  inputs:
                    buildType: 'current'
                    downloadType: 'single'
                    artifactName: 'srgg-marketplace'
                    downloadPath: '$(System.ArtifactsDirectory)'

                # Deploy to Azure App Service
                - task: AzureWebApp@1
                  displayName: 'ðŸŒ Deploy to Azure App Service (Production)'
                  inputs:
                    azureSubscription: '$(AzureSubscription)'
                    appType: 'webAppLinux'
                    appName: '$(ProductionAppName)'
                    package: '$(System.ArtifactsDirectory)/srgg-marketplace'
                    runtimeStack: 'NODE|20-lts'
                    startUpCommand: 'npm run start'

                # Verify deployment
                - script: |
                    echo "##vso[task.logissue type=info]âœ… Production deployment complete!"
                    echo "URL: https://$(ProductionAppName).azurewebsites.net"
                  displayName: 'âœ… Deployment Summary'

  # ============================================
  # STAGE 4: POST-DEPLOYMENT HEALTH CHECK
  # ============================================
  - stage: HealthCheck
    displayName: 'ðŸ¥ Health Check'
    dependsOn:
      - DeployStaging
      - DeployProduction
    condition: succeededOrFailed()

    jobs:
      - job: CheckHealth
        displayName: 'Verify Deployment Health'
        pool:
          vmImage: 'ubuntu-latest'

        steps:
          - script: |
              echo "Checking application health..."

              # Check staging if it was deployed
              if [ "$(isDevelop)" = "True" ]; then
                echo "Checking staging: https://$(StagingAppName).azurewebsites.net/api/health"
                curl -f https://$(StagingAppName).azurewebsites.net/api/health || echo "Staging health check pending..."
              fi

              # Check production if it was deployed
              if [ "$(isMain)" = "True" ]; then
                echo "Checking production: https://$(ProductionAppName).azurewebsites.net/api/health"
                curl -f https://$(ProductionAppName).azurewebsites.net/api/health || echo "Production health check pending..."
              fi

              echo "Health checks complete!"
            displayName: 'ðŸ¥ Run Health Checks'
            continueOnError: 'true'
